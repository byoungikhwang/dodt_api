# 2026-01-05 Media API 500 에러 해결 및 개선

## 문제

`/api/media` GET 엔드포인트에서 정렬(`sort`), 페이지네이션(`page`, `limit`) 파라미터와 함께 호출 시 `500 Internal Server Error`가 발생했습니다.

## 원인 분석

1.  **SQL 구문 오류**: `app/repositories/media_repository.py`의 `get_feed_media` 함수에서 `COUNT()` 집계 함수를 사용하면서 `SELECT` 절의 모든 비집계 컬럼을 `GROUP BY` 절에 포함하지 않아 PostgreSQL에서 오류가 발생했습니다.
2.  **예외 처리 부재**: API의 모든 계층(라우터, 서비스, 레포지토리)에 `try...except`와 같은 예외 처리 블록이 없어, 데이터베이스 오류가 그대로 서버 전체의 500 에러로 이어졌습니다.
3.  **비표준 응답 형식**: API 응답 모델이 `List[dict]`로 정의되어 있어 페이지네이션 정보(총 개수, 총 페이지 수 등)를 클라이언트에 전달할 수 없었고, 응답 구조가 명확하지 않았습니다.

## 해결 및 변경 내역

### 1. `app/schemas.py`

-   **`MediaResponse` 스키마 추가**: 개별 미디어 항목의 데이터 구조를 정의했습니다. (`id`, `title`, `like_count`, `liked_by_user` 등 포함)
-   **`MediaListResponse` 스키마 추가**: 페이지네이션을 포함한 최종 API 응답 형식을 표준화했습니다. (`success`, `data`, `total`, `page`, `limit`, `total_pages` 필드 포함)

### 2. `app/repositories/media_repository.py`

-   **`get_feed_media` 함수 수정**:
    -   SQL 쿼리의 `GROUP BY` 절을 수정하여 `SELECT`된 모든 비집계 컬럼을 포함시켰습니다. (`GROUP BY m.id, u.name, u.picture`)
    -   `liked_by_user` 필드 로직을 수정하여, 로그인 여부와 관계없이 항상 `boolean` 값을 반환하도록 `COALESCE`와 `bool_or`를 사용하여 쿼리를 견고하게 만들었습니다.
-   **`get_total_media_count` 함수 추가**:
    -   페이지네이션에 필요한, 검색 조건에 맞는 미디어의 총 개수를 계산하는 함수를 새로 추가했습니다.

### 3. `app/services/media_service.py`

-   **`get_total_media_count` 함수 추가**: `repository`에 추가된 `get_total_media_count` 함수를 `router`에서 사용할 수 있도록 서비스 계층에 동일한 이름의 함수를 추가했습니다.

### 4. `app/routers/media_router.py`

-   **`get_feed_media` 함수 수정**:
    -   **예외 처리 추가**: 함수 전체 로직을 `try...except` 블록으로 감싸, 오류 발생 시 `HTTPException(status_code=500)`을 반환하도록 하여 서버가 다운되는 것을 방지했습니다.
    -   **응답 모델 변경**: `response_model`을 `List[dict]`에서 새로 정의한 `MediaListResponse`로 변경했습니다.
    -   **페이지네이션 로직 구현**: `media_service`를 통해 미디어 목록과 전체 개수를 비동기적으로 동시에 조회하고, 이를 바탕으로 `total_pages`를 계산했습니다.
    -   **표준 응답 반환**: 조회된 데이터를 `MediaListResponse` 스키마 형식에 맞춰 가공한 후 반환하도록 수정했습니다.
-   **`import` 구문 추가**: `HTTPException`, `MediaListResponse`, `asyncio`를 추가로 import 했습니다.
