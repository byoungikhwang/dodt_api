# 2025-12-22 시스템 작업 요약

## From: add_html_analysis_ui_log.md

### 작업 내용
- 'add.html'에 고객 데이터 분석(Type 1) UI 구현

### 상세 내용
1.  **'app/templates/add.html' 파일 수정:**
    -   기존 플레이스홀더 내용을 제거하고, CSV 파일 업로드 폼을 구현했습니다.
    -   폼 제출 시 JavaScript `fetch` API를 사용하여 `/api/analysis/upload` 엔드포인트로 파일을 비동기적으로 전송하도록 설정했습니다.
    -   업로드 상태 및 분석 결과를 화면에 표시하는 UI 영역을 추가했습니다.
    -   `base.html`의 `scripts` 블록을 활용하여 페이지 로드 후 폼 제출 이벤트를 처리하는 JavaScript 코드를 포함했습니다.

이 변경 사항은 사용자가 CSV 파일을 업로드하여 고객 데이터를 분석하고 페르소나를 생성하는 첫 번째 기능 탭(Type 1 Generation Page)의 프론트엔드 UI를 제공합니다.

---

## From: admin_dashboard_integration_log.md

### 작업 내용
- 관리자 대시보드 API 및 UI 통합

### 상세 내용
1.  **'admin_router.py' 파일 수정:**
    -   모든 사용자 목록을 JSON 형태로 반환하는 새로운 API 엔드포인트 `GET /admin/users`를 추가했습니다.
    -   이 엔드포인트는 `get_current_admin_or_redirect` 의존성에 의해 보호되어 관리자만 접근할 수 있습니다.
    -   사용자 데이터 조회 시 `custom_id`, `credits`, `last_credit_grant_date` 등 확장된 사용자 정보를 포함하도록 쿼리를 업데이트했습니다.

2.  **'admin_dashboard.html' 파일 수정:**
    -   GitHub 리포지토리에서 가져온 `admin.html`의 내용을 기반으로 `app/templates/admin_dashboard.html` 파일을 업데이트했습니다.
    -   HTML 내 JavaScript `fetch` 호출 URL을 `'/users'`에서 새로 생성된 `'/admin/users'` API 엔드포인트로 변경했습니다.
    -   테이블 헤더 및 데이터 표시 부분을 `custom_id`, `role`, `credits`, `created_at` 등 확장된 사용자 정보를 포함하도록 수정했습니다.

이 변경 사항은 관리자 대시보드에서 사용자 데이터를 동적으로 조회하고 표시하는 기능을 구현합니다.

---

## From: admin_router_auth_guard_log.md

### 작업 내용
- 'admin_router.py' 파일 내 '/admin/dashboard' 라우터에 'get_current_admin_or_redirect' 의존성 적용

### 상세 내용
1.  **'admin_router.py' 파일 수정:**
    -   `app.dependencies.auth` 모듈에서 `get_current_admin_or_redirect`를 임포트했습니다.
    -   `/admin/dashboard` 라우터에 `Depends(get_current_admin)` 대신 `Depends(get_current_admin_or_redirect)`를 적용하여, 관리자 권한이 없는 사용자를 로그인 페이지로 리디렉션하거나 403 Forbidden 에러를 발생시키도록 보호했습니다.

이 변경 사항은 관리자 대시보드 페이지에 대한 접근 제어를 강화합니다.

---

## From: auth_dependencies_update_log.md

### 작업 내용
- 'auth.py' 파일 내 'get_current_admin_or_redirect' 의존성 추가

### 상세 내용
1.  **'auth.py' 파일 수정:**
    -   `RedirectResponse`를 임포트했습니다.
    -   `get_optional_user`에서 JWT 토큰 파싱 로직을 `cookie_token[7:]`로 개선했습니다.
    -   인증되지 않은 사용자를 `/login` 페이지로 리디렉션하는 새로운 의존성 함수 `get_current_user_or_redirect`를 추가했습니다.
    -   관리자 권한을 확인하고 리디렉션 로직을 포함하는 `get_current_admin_or_redirect` 의존성을 추가했습니다.

이 변경 사항은 웹 페이지에 대한 인증 가드 역할을 수행하며, 비로그인 사용자를 로그인 페이지로 리디렉션하고, 비관리자 사용자의 관리자 페이지 접근을 차단합니다.

---

## From: auth_guard_implementation_log.md

### 작업 내용
- Auth Guard (인증 가드) 기능 구현

### 상세 내용
1.  **'app/dependencies/auth.py' 파일 수정:**
    -   `RedirectResponse`를 임포트했습니다.
    -   `get_optional_user` 함수에서 쿠키 토큰을 파싱하는 로직 (`cookie_token.split(" ")[1]`)을 `cookie_token[7:]`으로 개선하여 더 견고하게 만들었습니다.
    -   새로운 의존성 `get_current_user_or_redirect`를 추가했습니다. 이 함수는 사용자가 인증되지 않았을 경우 `/login` 페이지로 리디렉션합니다.
    -   관리자 권한을 확인하고 리디렉션 로직을 포함하는 `get_current_admin_or_redirect` 의존성을 추가했습니다.

2.  **'app/routers/admin_router.py' 파일 수정:**
    -   `/admin/dashboard` 라우터에 `Depends(get_current_admin_or_redirect)`를 적용하여, 비관리자 사용자가 관리자 대시보드에 접근 시 리디렉션 또는 권한 없음 에러를 발생시키도록 보호했습니다.

3.  **'app/routers/user_router.py' 파일 수정:**
    -   `/user/profile` 라우터에 `Depends(get_current_user_or_redirect)`를 적용하여, 인증되지 않은 사용자가 프로필 페이지에 접근 시 로그인 페이지로 리디렉션되도록 보호했습니다.

4.  **'app/templates/feed.html' 및 'app/templates/add.html' 파일 생성:**
    -   "Feed" 및 "Add" 기능 탭을 위한 플레이스홀더 HTML 템플릿 파일을 생성했습니다.

5.  **'app/routers/index_router.py' 파일 수정:**
    -   `get_current_user_or_redirect`를 임포트했습니다.
    -   `/feed` 및 `/add` 경로에 대한 라우터를 추가하고, `Depends(get_current_user_or_redirect)`를 적용하여 이 페이지들을 보호했습니다.

이로써 명세서에서 요구하는 Auth Guard 기능이 구현되었습니다. 이제 인증되지 않은 사용자는 보호된 기능 탭에 접근할 수 없으며, 로그인 페이지로 리디렉션됩니다.

---

## From: base_html_ui_update_log.md

### 작업 내용
- 'base.html' UI 업데이트: 로고 이미지 및 내비게이션 바, 로고 호버 효과 구현
- 로고 이미지 플레이스홀더 생성

### 상세 내용
1.  **로고 이미지 플레이스홀더 생성:**
    -   `app/static/images/` 디렉토리를 생성했습니다.
    -   로고 호버 효과에 사용될 `image0.png` 및 `image0_1.png` 플레이스홀더 이미지 파일을 `app/static/images/` 경로에 생성했습니다.
2.  **'base.html' 파일 수정:**
    -   **내비게이션 바 브랜드 변경:** 'AI Persona' 텍스트 브랜드를 `image0.png`를 사용하는 이미지 로고로 교체했습니다.
    -   **내비게이션 링크 업데이트:** 명세에 따라 `Home`, `Feed`, `Add`, `My Page`, `Auth` 링크를 내비게이션 바에 추가했습니다. 기존 사용자 관련 드롭다운 메뉴는 유지됩니다.
    -   **로고 호버 효과 구현:** `main-logo` 이미지에 마우스 오버 시 `image0_1.png`로, 마우스 아웃 시 `image0.png`로 부드럽게 전환되는 JavaScript 코드를 `base.html`의 하단에 추가했습니다.

이 변경 사항은 사용자 인터페이스의 핵심 요소들을 명세에 따라 업데이트합니다.

---

## From: db_schema_update_log.md

### 작업 내용
- 데이터베이스 'users' 테이블 스키마 업데이트

### 상세 내용
1.  **'db/schema.sql' 파일 수정:** 'users' 테이블에 다음 컬럼을 추가했습니다.
    -   `custom_id VARCHAR(10) UNIQUE`: 사용자 고유 ID (ABC1234 형식)
    -   `credits INTEGER DEFAULT 1`: 사용자 크레딧 (초기값 1)
    -   `last_credit_grant_date DATE DEFAULT CURRENT_DATE`: 마지막 크레딧 부여 날짜 (초기값 오늘 날짜)

이 변경 사항은 사용자 관리 및 크레딧 시스템 구현의 기반이 됩니다.

---

## From: generate_type2_implementation_log.md

### 작업 내용
- 생성 페이지 Type 2 (AI Persona Generation) 구현

### 상세 내용
1.  **'app/templates/generate_type2.html' 파일 생성:**
    -   성별, 키, 체형, 스타일, 컬러톤, 사진 업로드 슬롯 등을 포함하는 상세한 AI 페르소나 생성 폼 UI를 구현했습니다.
    -   키 슬라이더와 컬러톤 체크박스에 대한 클라이언트 측 JavaScript 로직을 포함하여 사용자 경험을 개선했습니다.
    -   폼 제출 시 `/api/persona/generate` (플레이스홀더) 엔드포인트로 데이터를 비동기적으로 전송하는 JavaScript 코드를 포함했습니다.

2.  **'app/routers/index_router.py' 파일 수정:**
    -   `/generate-type2` 경로에 대한 GET 라우터를 추가하여 `generate_type2.html` 템플릿을 렌더링하도록 설정했습니다.
    -   이 라우터는 `get_current_user_or_redirect` 의존성에 의해 보호되어 인증된 사용자만 접근할 수 있습니다.

3.  **'app/templates/base.html' 파일 수정:**
    -   내비게이션 바에 `/generate-type2`로 연결되는 'Add (Persona)' 링크를 추가했습니다.

이 변경 사항은 명세서에 따른 두 번째 생성 페이지 UI를 제공하며, 사용자가 상세한 정보를 입력하여 AI 페르소나를 생성할 수 있는 기반을 마련합니다. 백엔드 API (`/api/persona/generate`) 구현은 다음 단계에서 이루어질 수 있습니다.

---

## From: gitignore_update_log.md

### 작업 내용
- '.gitignore' 파일 업데이트: 버전 관리 제외 항목 추가

### 상세 내용
1.  **'.gitignore' 파일 수정:** GitHub에 업로드되지 않아야 할 시스템 및 캐시 파일들을 Git 버전 관리에서 제외하기 위해 '.gitignore' 파일을 업데이트했습니다.
    -   **추가된 항목:**
        -   `venv/`: Python 가상 환경 파일
        -   `__pycache__/`: Python 컴파일된 바이트코드 캐시 디렉토리
        -   `.vscode/`: VS Code IDE 설정 파일
        -   `*.log`: 모든 로그 파일

이로써 해당 파일들은 Git 저장소에 포함되지 않고 무시됩니다.

---

## From: homepage_login_refactor_log.md

### 작업 내용
- 홈페이지 및 로그인 기능 재구성

### 상세 내용
1.  **홈페이지 변경 (`index.html`):**
    -   기존 로그인 페이지였던 `index.html`을 명세서에 따라 자동 재생 비디오가 포함된 홈 페이지로 변경했습니다.
    -   `IntersectionObserver`를 사용하여 비디오가 화면에 보일 때만 재생되도록 구현했습니다.
    -   비디오 플레이스홀더(`nas.mp4`)를 생성하여 `app/static/videos/`에 추가했습니다.

2.  **로그인 페이지 신규 생성 (`login.html`):**
    -   기존 `index.html`의 로그인 UI를 `login.html`이라는 새로운 파일로 분리하여 로그인 전용 페이지를 만들었습니다.

3.  **인증 라우터 수정 (`auth_router.py`):**
    -   사용자가 `/login` 경로로 접속 시, 새로 만든 `login.html` 템플릿을 반환하도록 `auth_router.py`에 새로운 GET 엔드포인트를 추가했습니다.

4.  **기본 템플릿 수정 (`base.html`):**
    -   페이지별 JavaScript를 삽입할 수 있는 `{% block scripts %}`를 추가했습니다.
    -   내비게이션 바의 'Auth' 링크가 `/login`을 가리키도록 수정했습니다.
    -   사용자 인증 상태에 따라 `My Page`와 `Auth` 링크가 조건부로 보이도록 내비게이션 바 로직을 개선했습니다.

---

## From: n8n_setup_log.md

### 작업 내용
- n8n 연동을 위한 라우터 및 엔드포인트 설정

### 상세 내용
1.  **'n8n_router.py' 파일 생성:** n8n 워크플로우와의 연동을 위한 전용 라우터 파일을 'app/routers/' 디렉토리에 생성했습니다.
    -   **파일 위치:** 'app/routers/n8n_router.py'
    -   **포함된 엔드포인트:**
        -   `POST /api/v1/n8n/trigger`: n8n으로부터 데이터를 받아 처리하는 샘플 엔드포인트.
        -   `GET /api/v1/n8n/health-check`: n8n 연동 상태를 확인하기 위한 헬스 체크 엔드포인트.

2.  **'app/main.py' 파일 수정:** 생성한 'n8n_router'를 FastAPI 애플리케이션에 등록하여 엔드포인트가 활성화되도록 'app/main.py' 파일을 수정했습니다.
    -   `n8n_router`를 임포트하는 코드를 추가했습니다.
    -   `app.include_router(n8n_router.router)` 코드를 추가하여 라우터를 등록했습니다.

---

## From: user_router_auth_guard_log.md

### 작업 내용
- 'user_router.py' 파일 내 '/user/profile' 라우터에 'get_current_user_or_redirect' 의존성 적용

### 상세 내용
1.  **'user_router.py' 파일 수정:**
    -   `app.dependencies.auth` 모듈에서 `get_current_user_or_redirect`를 임포트했습니다.
    -   `/user/profile` 라우터에 `Depends(get_current_user_or_redirect)`를 적용하여, 인증되지 않은 사용자를 로그인 페이지로 리디렉션하도록 보호했습니다.

이 변경 사항은 사용자 프로필 페이지에 대한 접근 제어를 강화합니다.

---

## From: users_repository_credit_management_log.md

### 작업 내용
- 'users_repository.py' 파일에 사용자 정보 조회 및 크레딧 관리 메서드 추가

### 상세 내용
1.  **새로운 메서드 추가:**
    -   `get_user_by_id(conn: asyncpg.Connection, user_id: int)`: 사용자 ID로 사용자 정보를 조회합니다.
    -   `get_user_by_custom_id(conn: asyncpg.Connection, custom_id: str)`: `custom_id`로 사용자 정보를 조회합니다. `UserService`에서 `custom_id`의 고유성을 보장하는 데 사용됩니다.
    -   `update_user_credits(conn: asyncpg.Connection, user_id: int, new_credits: int, last_credit_grant_date: date = None)`: 사용자의 크레딧 및 마지막 크레딧 부여 날짜를 업데이트합니다.
2.  **'create_user' 메서드 수정:**
    -   `last_credit_grant_date` 인자의 타입 힌트를 `str`에서 `date`로 변경하여 `UserService`와의 타입 일관성을 맞췄습니다.

이 변경 사항은 `UserService`에서 크레딧 관리 로직을 구현하는 데 필요한 저장소 계층의 기능을 제공합니다.

---

## From: users_repository_update_log.md

### 작업 내용
- 'users_repository.py' 파일 내 'create_user' 메서드 업데이트

### 상세 내용
1.  **'create_user' 메서드 시그니처 및 쿼리 변경:**
    -   `custom_id`, `credits`, `last_credit_grant_date` 파라미터를 추가하도록 메서드 시그니처를 업데이트했습니다.
    -   `INSERT` 쿼리를 수정하여 새로 추가된 `custom_id`, `credits`, `last_credit_grant_date` 컬럼에 값을 저장하도록 했습니다.

이 변경 사항은 사용자 생성 시 고유 ID 및 크레딧 초기화를 지원합니다.

---

## From: users_service_credit_management_log.md

### 작업 내용
- 'users_service.py' 파일에 크레딧 관리 로직 구현 및 'get_or_create_user' 업데이트

### 상세 내용
1.  **새로운 메서드 추가:**
    -   `_check_and_grant_daily_credit`: 사용자의 마지막 크레딧 부여일과 현재 날짜를 비교하여, 하루가 지났을 경우 1 크레딧을 추가하고 부여일을 업데이트합니다.
    -   `deduct_credit`: 사용자 크레딧을 1 차감합니다. 크레딧이 부족할 경우 `HTTPException`을 발생시킵니다.
2.  **'get_or_create_user' 메서드 수정:**
    -   **'custom_id' 고유성 확보:** 신규 사용자 생성 시 `_generate_custom_id`를 통해 생성된 `custom_id`가 데이터베이스 내에서 고유한지 확인하는 로직을 추가했습니다. (반복 생성 및 조회)
    -   **기존 사용자 크레딧 확인 및 부여:** 기존 사용자가 로그인할 때마다 `_check_and_grant_daily_credit`를 호출하여 일일 무료 크레딧 부여 로직을 실행하도록 했습니다.
    -   크레딧 관련 로직 변경 사항을 반영하기 위해 `date`, `datetime`, `timedelta`, `HTTPException`, `status`를 임포트했습니다.

이 변경 사항은 사용자 크레딧 시스템의 핵심 로직을 구현하고, `custom_id`의 고유성을 보장하여 명세서의 요구사항을 충족합니다.

---

## From: users_service_update_log.md

### 작업 내용
- 'users_service.py' 파일 내 'get_or_create_user' 메서드 업데이트 및 'custom_id' 생성 로직 추가

### 상세 내용
1.  **'custom_id' 생성 헬퍼 함수 추가:** `ABC1234` 형식의 고유한 `custom_id`를 생성하는 `_generate_custom_id` 메서드를 `UserService` 클래스 내에 추가했습니다.
2.  **'get_or_create_user' 메서드 수정:**
    -   신규 사용자 생성 시 `_generate_custom_id`를 호출하여 `custom_id`를 생성하도록 변경했습니다.
    -   생성된 `custom_id`와 함께 `initial_credits` (기본값 1), `last_credit_grant_date` (오늘 날짜) 정보를 `user_repo.create_user` 메서드에 전달하여 저장하도록 업데이트했습니다.

이 변경 사항은 사용자 로그인 시 고유 ID 및 크레딧 초기화 로직을 구현합니다.

---

## From: video_management_feature_log.md

### 작업 내용
- RBAC - 관리자: 비디오 업로드 및 관리 기능 구현

### 상세 내용
1.  **'db/schema.sql' 파일 수정:**
    -   비디오 메타데이터를 저장하기 위한 `videos` 테이블 스키마를 추가했습니다.

2.  **'app/templates/admin_videos.html' 파일 생성:**
    -   관리자가 비디오를 업로드하고, 목록을 조회하며, 삭제할 수 있는 UI를 구현했습니다.
    -   JavaScript `fetch` API를 사용하여 백엔드 비디오 API와 비동기적으로 통신하도록 설정했습니다.

3.  **'app/routers/admin_router.py' 파일 수정:**
    -   `admin_videos.html` 템플릿을 제공하는 `/admin/videos` 라우터를 추가하고, 관리자 인증 가드로 보호했습니다.
    -   기존 `/admin/dashboard`에 비디오 관리 페이지로 이동하는 탭 링크를 추가했습니다.

4.  **비디오 관리 모듈 생성:**
    -   **'app/repositories/video_repository.py'**: `videos` 테이블에 대한 CRUD 작업을 수행하는 `VideoRepository`를 생성했습니다.
    -   **'app/services/video_service.py'**: 비디오 파일 저장, DB 레코드 생성/삭제 등 비즈니스 로직을 처리하는 `VideoService`를 생성했습니다.
    -   **'app/routers/video_router.py'**: 비디오 업로드(`POST /api/videos/upload`), 목록 조회(`GET /api/videos/`), 삭제(`DELETE /api/videos/{video_id}`)를 위한 API 엔드포인트들을 포함하는 `VideoRouter`를 생성했습니다. 모든 엔드포인트는 관리자 권한으로 보호됩니다.

5.  **'app/main.py' 파일 수정:**
    -   `video_router`를 FastAPI 앱에 등록하여 비디오 관리 API를 활성화했습니다.

이 변경 사항은 명세서에 따른 관리자 전용 비디오 관리 기능을 완전히 구현합니다.

---

## From: videos_table_schema_log.md

### 작업 내용
- 데이터베이스 'videos' 테이블 스키마 추가

### 상세 내용
1.  **'db/schema.sql' 파일 수정:** 관리자가 업로드한 비디오의 메타데이터를 저장하기 위해 새로운 'videos' 테이블을 추가했습니다.
    -   **테이블 구조:**
        -   `id`: 비디오 고유 ID
        -   `title`: 비디오 제목
        -   `filename`: 원본 파일 이름
        -   `filepath`: 저장된 파일 경로
        -   `uploaded_by`: 업로드한 관리자 ID (users 테이블 참조)
        -   `created_at`: 업로드 시간

이 변경 사항은 관리자의 비디오 업로드 및 관리 기능 구현을 위한 데이터베이스 기반을 마련합니다.
