{% extends "base.html" %}

{% block title %}Media Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Media Management</h1>
    <p>Upload new media (videos or images) and manage existing ones.</p>

    <!-- Media Upload Form -->
    <div class="card p-4 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Upload New Media</h5>
            <form id="media-upload-form">
                <div class="mb-3">
                    <label for="mediaTitle" class="form-label">Media Title</label>
                    <input type="text" class="form-control" id="mediaTitle" name="title" required>
                </div>
                <div class="mb-3">
                    <label for="mediaDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="mediaDescription" name="description" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="mediaType" class="form-label">Media Type</label>
                    <select class="form-select" id="mediaType" name="media_type" required>
                        <option value="video">Video</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="mediaFile" class="form-label">Select Media File</label>
                    <input class="form-control" type="file" id="mediaFile" name="file" accept="video/*,image/*" required>
                </div>
                <button type="submit" class="btn btn-primary">Upload Media</button>
            </form>
            <div id="media-upload-status" class="mt-3"></div>
        </div>
    </div>

    <!-- Media List Table -->
    <div class="card p-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">Existing Media</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>URL</th>
                        <th>Uploaded At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="media-list-body">
                    <!-- Media list will be dynamically populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const mediaUploadForm = document.getElementById('media-upload-form');
    const uploadStatus = document.getElementById('media-upload-status');
    const mediaListBody = document.getElementById('media-list-body');

    // Function to fetch and display media
    async function loadMedia() {
        try {
            const response = await fetch('/api/media/', { credentials: 'include' });
            if (!response.ok) throw new Error('Failed to load media');
            const mediaItems = await response.json();

            mediaListBody.innerHTML = ''; // Clear existing list
            mediaItems.forEach(media => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${media.id}</td>
                    <td>${media.title}</td>
                    <td>${media.media_type}</td>
                    <td><a href="${media.url}" target="_blank">${media.url.split('/').pop()}</a></td>
                    <td>${new Date(media.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteMedia(${media.id})">Delete</button>
                    </td>
                `;
                mediaListBody.appendChild(row);
            });
        } catch (error) {
            mediaListBody.innerHTML = '<tr><td colspan="6" class="text-danger">Could not load media.</td></tr>';
            console.error(error);
        }
    }

    // Function to delete a media item
    window.deleteMedia = async function(mediaId) {
        if (!confirm('Are you sure you want to delete this media item?')) {
            return;
        }
        try {
            const response = await fetch(`/api/media/${mediaId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to delete media item');
            }
            alert('Media item deleted successfully!');
            loadMedia(); // Reload the list
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    };

    // Handle media upload form submission
    mediaUploadForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        uploadStatus.innerHTML = '<div class="alert alert-info">Uploading...</div>';
        
        const formData = new FormData();
        formData.append('title', document.getElementById('mediaTitle').value);
        formData.append('description', document.getElementById('mediaDescription').value);
        formData.append('media_type', document.getElementById('mediaType').value);
        formData.append('file', document.getElementById('mediaFile').files[0]);

        try {
            const response = await fetch('/api/media/upload', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Upload failed');
            }
            
            uploadStatus.innerHTML = '<div class="alert alert-success">Media uploaded successfully!</div>';
            mediaUploadForm.reset();
            loadMedia(); // Refresh the media list
        } catch (error) {
            uploadStatus.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });

    // Initial load of media
    loadMedia();
});
</script>
{% endblock %}