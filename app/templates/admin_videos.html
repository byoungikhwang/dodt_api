{% extends "base.html" %}

{% block title %}Video Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Video Management</h1>
    <p>Upload new videos and manage existing ones.</p>

    <!-- Video Upload Form -->
    <div class="card p-4 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Upload New Video</h5>
            <form id="video-upload-form">
                <div class="mb-3">
                    <label for="videoTitle" class="form-label">Video Title</label>
                    <input type="text" class="form-control" id="videoTitle" name="title" required>
                </div>
                <div class="mb-3">
                    <label for="videoFile" class="form-label">Select Video File</label>
                    <input class="form-control" type="file" id="videoFile" name="video" accept="video/*" required>
                </div>
                <button type="submit" class="btn btn-primary">Upload Video</button>
            </form>
            <div id="video-upload-status" class="mt-3"></div>
        </div>
    </div>

    <!-- Video List Table -->
    <div class="card p-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">Existing Videos</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Filename</th>
                        <th>Uploaded At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="video-list-body">
                    <!-- Video list will be dynamically populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const videoUploadForm = document.getElementById('video-upload-form');
    const uploadStatus = document.getElementById('video-upload-status');
    const videoListBody = document.getElementById('video-list-body');

    // Function to fetch and display videos
    async function loadVideos() {
        try {
            const response = await fetch('/api/videos/');
            if (!response.ok) throw new Error('Failed to load videos');
            const videos = await response.json();

            videoListBody.innerHTML = ''; // Clear existing list
            videos.forEach(video => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${video.id}</td>
                    <td>${video.title}</td>
                    <td>${video.filename}</td>
                    <td>${new Date(video.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteVideo(${video.id})">Delete</button>
                    </td>
                `;
                videoListBody.appendChild(row);
            });
        } catch (error) {
            videoListBody.innerHTML = '<tr><td colspan="5" class="text-danger">Could not load videos.</td></tr>';
            console.error(error);
        }
    }

    // Function to delete a video
    window.deleteVideo = async function(videoId) {
        if (!confirm('Are you sure you want to delete this video?')) {
            return;
        }
        try {
            const response = await fetch(`/api/videos/${videoId}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to delete video');
            }
            alert('Video deleted successfully!');
            loadVideos(); // Reload the list
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    };

    // Handle video upload form submission
    videoUploadForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        uploadStatus.innerHTML = '<div class="alert alert-info">Uploading...</div>';
        
        const formData = new FormData(videoUploadForm);
        try {
            const response = await fetch('/api/videos/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Upload failed');
            }
            
            uploadStatus.innerHTML = '<div class="alert alert-success">Video uploaded successfully!</div>';
            videoUploadForm.reset();
            loadVideos(); // Refresh the video list
        } catch (error) {
            uploadStatus.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });

    // Initial load of videos
    loadVideos();
});
</script>
{% endblock %}